{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":"Note <p>I'm still polishing up this site. If you find something off, let me know. </p>"},{"location":"about/","title":"About","text":""},{"location":"about/#data","title":"Data","text":"<pre><code>@{\n    Name = \"Tyler Jacobs\"; Alias = \"Poolmanjim\"\n    About = @(\n        'Husband',\n        'Boy Dad++',\n        'Health Care Sysadmin'\n    )\n    ExperienceInYears = Get-Random -Min 15 -Max 20\n    JobTitle = @(\n        \"Principal Security Engineer\",\n        \"Directory Services\"\n    )\n    Organization = \"UNDISCLOSED\"\n    # My views are mine.\n    Other = \"Moderator of r/ActiveDirectory\"\n    Interests = @(\n        'Identity',\n        'Homelab',\n        'TTRPG/Gaming'\n    )\n}\n</code></pre>"},{"location":"about/#more-about","title":"More About?","text":"<p>I've been in IT for somewhere between 15 and 20 years depending on how you measure start. My focus has been Windows Server with a heavy emphasis on On-Prem Active Directory and identity. I also tend to find myself somewhere between line 500 and 1000 of a decent PowerShell script. </p> <p>My experience has been primarily with enterprise-scale Windows Server environments and managing their AD consisting of anywhere from a few dozen domain controllers to literally more than 1000. I've done in-house training, built Tiering models, and even worked on an ESAE/Red Forest design. </p> <p>My real life is being a boy dad to two little men and a husband to an amazing, math-wizard wife. When I'm not working or doing the family thing, I mess around in a homelab where I learn about the things work won't let me learn about. There I've got anywhere from a couple of Windows VMs to a dozen Windows VMs and a handful of Linux VMs depending on the need. I like experimenting and breaking stuff to figure out how it works. </p>"},{"location":"about/#github-link","title":"Github Link","text":"<p>https://github.com/ActiveDirectoryKC</p>"},{"location":"about/#qualifications","title":"Qualifications","text":"<ul> <li>10+ years with Enterprise-level Active Directory</li> <li>7 years of technical lead/architect experience</li> <li>15-20 years of experience with Windows Server</li> </ul>"},{"location":"about/#certifications-education","title":"Certifications / Education","text":"<ul> <li>MCSE: Cloud Platform and Infrastructure</li> <li>MCSA: Server 2016</li> <li>MCSA: Server 2012</li> </ul>"},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/","title":"Cannot bind argument to parameter Exception because it is null with Backup-BitLockerKeyProtector","text":"<p>Cannot bind argument to parameter Exception because it is null with Backup-BitLockerKeyProtector</p> <p>Over the past year, I have been in a number of conversations about setting up Active Directory Sites and Services in a network that is not fully routed. Articles exist on the subject \u2014 some from Microsoft and some not. All the articles seem to skip a step or don\u2019t linger on a detail I\u2019d like to expand on.</p> <p>The question of \u201cHow do I configure Active Directory in a non-routed environment?\u201d isn\u2019t uncommon. With more organizations segmenting out their networks, with more B2B contracts encouraging companies to play well with one another, or whatever the need to ensure that AD plays across confusing site designs is imperative.</p> <p>Fortunately, there resources and articles out that detailing just this sort of thing. Unfortunately, like all things, they are often incomplete or gloss over an important step. Even more unfortunate, with Microsoft\u2019s recent drive to remove \u201coutdated\u201d documentation some of the gems of the past have gone missing. I hope to give some insight into how to configure AD to work with non-routed or poorly routed networks. I will focus on the Sites and Services side and give some guidance on the GPOs, firewall policies, and as many details that make sense as I dig into it.</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#lab-setup","title":"Lab Setup","text":"<p>I have a CORP domain with two sites, CORP and WAREHOUSE (WH), and two child domains spun off of the CORP parent, RETAIL and OPS. RETAIL and OPS need to be segregated from each other and from WAREHOUSE. Everyone needs to be able to talk back and forth with the CORP site.</p> <p>Each site has its own subnet in my design. The subnets are routed in my lab since that is how my lab is setup. Rather than breaking the routes I\u2019m using Windows Firewall to block MS-RPC and LDAP traffic between the sites and warehouse.</p> <p>Another thing worth mentioning is I disabled Bridge All Site Links (BASL) and changed how DCs create SRV records. I\u2019ll explain why I did this below but understand that it is a crucial part to how this whole thing is architected.</p> <p>Last, the specific details about the lab (number of DCs, DC hardware, etc.) are left out. It shouldn\u2019t matter in this step. All that matters is that every site has a DC and every DC has a site.</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#disclaimer-1-proper-site-design","title":"Disclaimer #1 \u2013 Proper Site Design","text":"<p>I\u2019ve looked at a lot of environments and worked with a lot of admins trying to make their AD work like a charm. One of the most neglected, yet critical, pieces of a proper AD setup is the Site and Services configuration. This is even more prevalent in medium-sized organizations and larger as they tend to have more sites and thus more complexity. Admins tend to setup AD Sites and Services with the out-of-the-box defaults and it just works. Why change it? Or, they don\u2019t understand it enough to change it with confidence.</p> <p>For a non-routed AD topology to work, your Sites and Services must be solid. If it isn\u2019t there will be issues. Map your subnets to their sites, ensure that proper sites are configured, make sure that ever site has a DC, etc. These are all import. However, you must understand your network topology appropriately and make sure that that topology is correctly mirrored in AD Sites and Services (within reason).</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#testing-it-all-before-breaking-it-all","title":"Testing it All Before Breaking it All","text":"<p>Before breaking an environment it is important to know that said environment works. I want my directory full converged with all DCs having successful replications and a DNS that resolves as I would expect.</p> <p>I ran the following checks on every DC to verify everything worked. If these come back without errors it is likely all things are peachy.</p> <pre><code>dcdiag\nRepadmin /showrepl /errorsonly\nRepadmin /replsum\nNltest /dsgetdc:\nNltest /dsgetdc: /avoidself\nNltest /dsgetdc:company.pri\nNltest /dsgetdc:retail.company.pri\nNltest /dsgetdc:ops.company.pri\n</code></pre>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#sites-and-services-setup","title":"Sites and Services Setup","text":"<p>Each of the sites I mentioned above were created with their own /24 subnet. Site Links were created back to the CORP site. To make sure replication worked as I expected, I wanted to make sure that each site link has both a low cost and have a short replication interval. I also went through and configured change notification on each site link.</p> <p>The default cost is 100 and the default replication interval is 180 minutes. That is fine, but I like to change those\u00a0 numbers. Three hours for convergence with just one set of links is not fast enough for my setup. Remember that site link costs are cumulative. Assuming for a moment that I wanted WAREHOUSE to replicate something with RETAIL they have to cross between CORP to do that. This means that with a replication period of 180 minutes for each site link it could take a total of 360 minutes for the change in WAREHOUSE to get to RETAIL. Let\u2019s change the defaults. Change notification gets around some of this but we want the replication costs set right. Some stuff will always use that even with notify turned on.</p> <p></p> <p>Altering the cost and replication interval of the site links is very straight forward. I\u2019ll set the cost to 50 and the interval to the lowest possible value: 15. I\u2019ll be using PowerShell to do this, it is a one-and-done method that has a lot fewer clicks.</p> <pre><code>Get-ADReplicationSiteLink -Filter * | Set-ADReplicationSiteLink -Cost 50 -ReplicationFrequencyInMinutes 15\n</code></pre> <p>The above command first grabs all the Site Links in the forest (remember Sites and Services is a forest-wide part of AD). I then send those to Set-ADReplicationSiteLink and alter the cost and the replication frequency.</p> <p>Next, it is time to enable change notification on the site links. Within a site change notification is the default. Changing site links to behave the same way effectively makes the DCs all act as if they are in one site, even though great distances may be between them. This all means that the DCs in all my sites will converge very quickly, likely under a minute.</p> <p>Change Notification tells domain controllers to notify replication partners immediately upon receiving a change. If I add a user to a new group, in this scenario, the DC would notify its partners immediately that the change happened and then they would request the change be replicated. Without change notification the DCs store up changes and send all the data as a big chunk of replication traffic at every replication interval. Rather than communicating larger pieces of information periodically change notification communicates with a frequent, but small, series of notifications about changes.</p> <p>I changed change notification because Microsoft has been recommending it for most environments for years. Smaller environments may not even need it as they are unlikely to have multiple sites. Medium and larger environments could benefit from it assuming their sites are well-connected.</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#disclaimer-2-risks-of-change-notify","title":"DISCLAIMER #2 \u2013 Risks of Change Notify","text":"<p>First, DCs are more chatty. They send little pieces of information rather than large pieces. Bandwidth-wise this shouldn\u2019t matter all that much but I have seen cases where it wasn\u2019t an ideal setup.</p> <p>Second, if you have already configured options on your site link (you will know if you have) if you blindly follow my steps you can blow away what you currently have which may not be ideal. The options field uses bitmasks. If you have any concerns about blowing something away, check the References section below for some notes and do some of your own research beforehand.</p> <p>Finally, another risk of change notify is speed of changes. In a standard replication model, if I were to change the group membership of a user it would queue up that change and send it during the replication interval later. If I were to change that user\u2019s group membership a second time before the interval hit, both changes go through. If that second change were to remove the user from the group I had just added them to, only the second changes goes through as AD would only send what was relevant. Change notification will make it where each change along the course of work will be near immediately replicated. So your mistakes may become environment-wide mistakes faster with change notification on. This is a minor risk as most changes are rather non-impacting on their own, but keep all that in mind as you go forward.</p> <p></p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#configuring-change-notification","title":"Configuring Change Notification","text":"","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#manual-method","title":"Manual Method","text":"<ol> <li>Right-Click the Site Link \\ Properties</li> <li>Attribute Editor Tab</li> <li>Locate the Options Attribute</li> <li>Edit \u201cOptions\u201d</li> <li>Set the value to \u201c1\u201d</li> <li>Options should now show \u201c0x1 = (USE_NOTIFY)\u201d</li> </ol>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#powershell-method","title":"PowerShell Method","text":"<pre><code>Get-ADReplicationSiteLink -Filter * | Set-ADReplicationSiteLink -Add @{\"options\"=1}\n</code></pre> <p>In the Powershell method I set it for every site link at once. I also hope you noticed there isn\u2019t a -UseNotify or -Options switch on the command. Microsoft decided to make this command a little complicated. Fortunately, the -Add switch and its kindred allows us to do just about whatever we need to the attributes on this object type.</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#disclaimer-3-why-are-you-not-routing-your-sites","title":"Disclaimer #3 \u2013 Why Are You Not Routing Your Sites?","text":"<p>We are now ready to start creating a non-routed site and services topology. But first, I want to ask the question:\u00a0Why are you not routing your sites?</p> <p>A lot of organizations I\u2019ve worked with do this because of \u201csecurity\u201d reasons. Tenant A shouldn\u2019t be able to talk to Tenant B. If that is the case, while this design accomplishes that goal the best practice is to create separate forests. AD assumes all sites and domains in a forest can talk with one another, at least to some degree. If you break those sites or domains off into their own forests, there is no assumption of communication. I know there are some administrative hurdles there but those are not something that can\u2019t be dealt with.</p> <p>I\u2019m not saying that you are chosing a bad design, I\u2019m simply asking that you consider moving forward cautiously. Make sure you understand why you want to do this and that it makes the best sense for your environment. There is rule of thumb with AD, even a blog post about it from Microsoft: You are not smarter than the KCC. So let it do what it does.</p> <p>https://docs.microsoft.com/en-us/archive/blogs/markmoro/you-are-not-smarter-than-the-kcc</p> <p>Okay, that is my final warning before we start doing this.</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#creating-a-non-routed-site-design","title":"Creating a Non-Routed Site Design","text":"<p>As I said before, rather than configuring my Vyos lab router to not route between my /24 links, I decided to use the Windows Defender Firewall to block LDAP 389 and the RPC Dynamic Port Range (49152 \u2013 65535) for each domain. I only blocked it inbound on the other domains controllers. I have more details on this and some its challenges in the \u201cDig Deeper\u201d section at the end of this post.</p> <p>This method is not the recommended way to firewall off sites and I only did it out of convenience. If you wanted to do this in production, work with your network team and properly route/firewall your network.</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#disabling-bridge-all-site-links","title":"Disabling Bridge All Site Links","text":"<p>By default Active Directory bridges all site links together. This allows every site to have a \u201cdirect\u201d connection with every other site which means AD will create connections between sitelinks to create a intersite mesh topology of sorts. It also ensure that replication can go in virtually any direction. Remember the goal of the ISTG and KCC in this case to ensure the topology that achieves convergence as quickly as possible.</p> <p>In a normal environment, Bridge All Site Links (BASL) should be left on. It works and most environments don\u2019t do anything weird with their sites like this. That being said, Microsoft does have two scenarios where they recommend disabling BASL: 1) the network is not fully routed and 2) you need to control the flow of replication manually. Generally, you have the second scenario because of the first or you have an enormous environment that doesn\u2019t allow for natural replication paths.</p> <p>https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/creating-a-site-link-bridge-design</p> <p>Obviously, I\u2019m doing it because our sites aren\u2019t intended to communicate. Why create links that won\u2019t work anyway. So let\u2019s just turn it off. If for some reason you were relying on Bridge All Site Links for something, you can simply setup a manual site link bridge between those site links.</p> <p></p> <ol> <li>Login to one of the root domain controllers</li> <li>Launch AD Sites and Services</li> <li>Expand Sites</li> <li>Expand \u201cInter-Site Transports\u201d</li> <li>Right-Click \u201cIP\u201d \\ Choose \u201cProperties\u201d</li> <li>On the General Tab \\ Uncheck \u201cBridge all site links\u201d</li> </ol> <p></p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#disabled-via-powershell","title":"Disabled via Powershell","text":"<pre><code>$ConfigDN = (Get-ADRootDSE).configurationNamingContext\nSet-ADObject -Identity \"CN=IP,CN=Inter-Site Transports,CN=Sites,$ConfigDN\" -Replace @{\"options\"=2}\n</code></pre> <p>According to the Open Protocol Information put out by Microsoft, there are only two options that can be configured on the Inter-Site Transports containers (IP or SMTP): Ignore Schedules and Bridge All Site Links. I think the likelihood of running into a scenario where the -Replace option for Powershell overwriting an existing option is remote. If you are concerned, use Get-ADObject to confirm your current configuration and adjust accordingly. See the below link to see the different options for the IP Container.</p> <p>https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/66db6a63-52d2-4980-b87b-7b2d598dba81</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#changing-how-ad-srv-records-are-registered","title":"Changing How AD SRV Records are Registered","text":"<p>Normally, AD does some cool stuff with SRV record registration. Specifically, DCs will log and respond to generic SRV records created in the root domain of a forest to help locate global catalogs services such as LDAP and Kerberos, among other things. These generic records act as fallback records if a site loses its DCs for whatever reason. A client will simply find a random DC to talk to so communication stays up.</p> <p>Since we\u2019ve firewalled off our different sites, I\u00a0 don\u2019t want a bunch of site records in the root of the domain that just go anywhere. I want only the root DC records in the root and the specific sub-domain DC records in their specific domains. The root will be able to handle if something goes wrong with the site but not another domain.</p> <p>Let\u2019s look at the defaults and then decide what to do.</p> <ol> <li>Launch DNS Management (dnsmgmt.msc)</li> <li>Expand Forward Lookup Zones</li> <li>Expand your root domain name</li> <li>Click on _tcp</li> <li>Specifically we are looking at the _gc records</li> </ol> <p></p> <p>Notice how we have a GC record for every domain controller in the domain. AD logs a record for each GC, and other records, in a generic record to help with DC Locator. First a client will try to locate a DC in its site and if that fails it passes up to the root \u201cgeneric\u201d records and receives a random entry that can be any domain controller in the domain or forest.</p> <p>You can view the site entries with the following nslookup query to return GCs only in the OPS site.</p> <pre><code>nslookup -type=srv _gc._tcp.OPS._sites.company.pri\n</code></pre> <p></p> <p>So the scenario we are looking at is that if a client looks for a GC in its site, either of the OPS DCs can respond. That is what we want. However, if a DC in the OPS site cannot respond or doesn\u2019t respond fast enough, DC Locator may step up and try to do a generic query to _gc._tcp.Company.Pri. That query can return any DC in the forest. If had blocked 3268/3269 or any communication is lost between my host and these DCs, how are GC queries supposed to work? It could possibly sit there and loop through the list of GCs until it finds a server it can talk to or it times out (55 hops).</p> <p>Never fear! There is a solution to this problem. We need to create a Group Policy. Actually, we need several.</p> <p>==DO NOT LINK THIS POLICY IN THE ROOT SITE/DOMAIN!!!==</p> <ol> <li>Launch Group Policy Management Editor</li> <li>Create a new policy called \u201cDC DNS Registration\u201d or something similar.</li> <li>Edit the new policy.</li> <li>Browse to \u201cComputer Configuration \\ Policies \\ Administrative Templates \\ System \\ Net Logon \\ DC Locator\u201d</li> <li>Double Click the setting \u201cSpecify DC Locator DNS records not registered by the DCs\u201d</li> <li>Specify the following values (I will cover these in the Digging Deeper section later). <code>DC DcByGuid Gc GcIpAddress GenericGC Kdc Ldap LdapIpAddress Rfc1510UpdKdc Rfc1510Kpwd Rfc1510UpdKdc Rfc1510UdpKpwd</code></li> <li>Close out the group policy editor and save the policy</li> <li>In GPMC Right-Click \u201cDomains\u201d \\ Choose \u201cShow Domains\u201d</li> <li>Choose one of the other child domains (Note: this must be done in the root if you killed 389)</li> <li>Right-Click the \u201cDC DNS Registration\u201d policy \\ Choose \u201cCopy\u201d</li> <li>Navigate to one of the other child domains in GPMC \\ Expand \u201cGroup Policy Objects\u201d</li> <li>Right Click \u201cGroup Policy Objects\u201d \\ Choose \u201cPaste\u201d</li> <li>Next through the prompts to copy the policy</li> <li>Link the policy to the Domain Controllers OU in the child domains. NOTE: For the love of all that is holy, please test the policy before going nuts and linking it in prod. If you brick your prod, it isn\u2019t my fault!</li> <li>Login to one of the child DCs and run gpupdate /force. I also suggest rebooting</li> <li>Repeat this process for other child domains.</li> </ol> <p>You may not have to reboot \u2013 most administrative template GPOs are real-time and take effect immediately without reboot. However, with computer policies its hard to predict. We also need the Netlogon service to restart as that will remove the old DNS records (assuming Dynamic DNS Registration is turned on).</p> <p>When the server comes back up, login and check your records. You may need to bounce Netlogon a couple of times and do an ipconfig /registerdns to clear the old records. Ultimately, if the records don\u2019t go away you can delete them manually out of DNS and they should not re-register.</p> <p></p> <p>You can see that the list got smaller with those records removed. Now if a GC in the local site cannot be resolved, we head up to the root for help instead of finding a random server in some random site/domain. I ran through my checks and everything looked healthy so this worked. You may receive some errors with nltest looking cross domains as those domains cannot talk and you will receive errors in the <code>repadmin /replsum</code> since the environment isn\u2019t fully routed.</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#conclusion","title":"Conclusion","text":"<p>I hope this helped you out! Send me a message or leave a comment if you have questions or if there is something else you\u2019d like me to cover. As always, test in non-prod or test environments before implementing any of this in production. See the below sections for references I used and some deeper dives into a couple of areas.</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#references","title":"References","text":"<p>Site Link Bridge Design https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/creating-a-site-link-bridge-design</p> <p>Enable or Disable Site Link Bridges https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc738789(v=ws.10)</p> <p>Preventing Spoke DCs from Advertising in the Hub for Authentication and Availability https://support.microsoft.com/en-us/help/816587/how-to-verify-that-srv-dns-records-have-been-created-for-a-domain-cont</p> <p>How to verify that SRV DNS Records have been created for a DC https://support.microsoft.com/en-us/help/816587/how-to-verify-that-srv-dns-records-have-been-created-for-a-domain-cont</p> <p>Optimize Location of a DC or GC https://support.microsoft.com/en-us/help/306602/how-to-optimize-the-location-of-a-domain-controller-or-global-catalog</p> <p>IP Container Bitmasks https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/66db6a63-52d2-4980-b87b-7b2d598dba81</p> <p>AD Firewall Stuff https://support.microsoft.com/en-us/help/179442/how-to-configure-a-firewall-for-domains-and-trusts</p> <p>Change Notification and You https://blogs.msdn.microsoft.com/canberrapfe/2012/03/25/active-directory-replication-change-notification-you/</p> <p>You are not smarter than the KCC</p> <p>https://blogs.technet.microsoft.com/markmoro/2011/08/05/you-are-not-smarter-than-the-kcc/</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#digging-deeper","title":"Digging Deeper","text":"","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#windows-firewall-configuration-to-lock-down-child-domains","title":"Windows Firewall Configuration to Lock Down Child Domains","text":"<p>As I mentioned above, I used Windows Firewall to lock down my sites and domains to prevent communication. Here are the settings I used and some reasoning behind my choices. I would not advise blocking 389 as it really screws with some management functions and can slow down AD (though in production you should be using 636 anyway). To block replication you should focus on the RPC Dynamic Range. You would probably want to do more blocks and more restrictions if you wanted to actually block two child domains.</p> <p>Ultimately, I would recommend doing these configurations with hardware firewalls and the like. This isn\u2019t really a sound use-case for Windows Firewall.</p> <p>==NOTE: DO NOT LINK THIS POLICY IN THE ROOT DOMAIN!!==</p> <ol> <li>Launch Group Policy Management Center</li> <li>Expand Domains \\ Select the domain that you wish to create the policy in</li> <li>Right-Click \u201cGroup Policy Objects\u201d \\ New</li> <li>Name the policy</li> <li>Right-Click the new policy \\ Edit</li> <li>Navigate to \u201cComputer Configuration \\ Policies \\ Windows Settings \\ Security Settings\u201d</li> <li>Expand \u201cWindows Firewall with Advanced Security\u201d</li> <li>Expand \u201cWindows Firewall with Advanced Security\u201d (Firewall Icon)</li> <li>Click \u201cInbound Rule\u201d</li> <li>Right-Click \u201cNew Rule\u201d</li> <li>Choose Port</li> <li>Leave TCP Selected</li> <li>Configure the following ports: 389, 49152-65535</li> <li>Choose to \u201cBlock the connection\u201d</li> <li>Leave all profiles selected</li> <li>Name the firewall rule (e.g. Block TCP 389, 49152-65535)</li> <li>Find the rule you just created \\ Right-Click the rule \\ Properties</li> <li>Click the \u201cScope\u201d tab</li> <li>Select \u201cThese IPs under Remote IP Address\u201d</li> <li>Add the different IPs of of the DCs you DO NOT want to talk to the DC this rule applies to.</li> <li>Click OK</li> <li>Repeate 10 \u2013 21 except configuring UDP instead of TCP.</li> <li>Repeat this process again for each domain you wish to lock down making sure to configure the correct IPs in the scope section.     DO NOT DO THIS IN THE ROOT DOMAIN</li> <li>Link the policies where appropriate.</li> </ol> <p>If you have separate sites in your root domain that you would like to lock down you\u2019ll need to use Security Filtering with Group Policy to target the DCs that you wish to restrict. I would avoid using site policies, even though this seems like a use case, as they don\u2019t always behave as you would expect and most admins don\u2019t know to check for or pay attention to them.</p> <p>If you wish to get more specific about what is being blocked, you can narrow down which ports are used for AD to a very granular level. See the \u201cMore Information\u201d section and the \u201cWindows Server 2008 and later versions\u201d section for the latest and greatest port list in the below link.</p> <p>https://support.microsoft.com/en-us/help/179442/how-to-configure-a-firewall-for-domains-and-trusts</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#site-links-vs-site-link-bridges","title":"Site Links vs Site Link Bridges","text":"<p>I\u2019m not going to lie to you. I honestly see no real use case for a Site Link Bridge. In my opinion Site Links cover the same topic and work fine. However, Microsoft has them so let\u2019s take a minute to talk about them.</p> <p>First, some definitions.</p> <p>Site Links are objects that represent logical paths that the KCC uses to establish connections for Active Directory replication. Sites contained within a site link use the same network cost to communicate through the specified inter-site transport (IP. SMTP is a relic of the past). Any sites in a site link are said to be connected by the means of the same network type. They are not intended to mirror actual network paths so redundant links is superfluous. When a site link is created between two sites, the KCC/ISTG automatically creates connections between DCs in each site via Bridgehead servers.</p> <p>Site Link Bridges are similar, they represent a set of site links that can communicate using the same transport. Bridges are used represent more indirect connections. The replication traffic will likely have to traverse more complicated routes to get from one site to another. The default is for the KCC to assume transitivity between all site links and thus create bridges in its own topology. The KCC will use any combination of included site links to establish the least expensive route to interconnect the domain controllers. The KCC adds up the cost of each additional site link and uses that sum for the bridged path\u2019s cost.</p> <p>Basically it breaks down to this: Site Links are for direct connections that would be physically adjacent networks and Site Link Bridges are used to connect networks that are not directly connected and must communicate via an intermediary.</p> <p>https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/replication/active-directory-replication-concepts#BKMK_6</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2020/08/24/cannot-bind-argument-to-parameter-exception-because-it-is-null-with-backup-bitlockerkeyprotector/#gpo-settings-overview","title":"GPO Settings Overview","text":"<p>Above we configured the Net Logon group policy to skip over specific records when Netlogon dynamically registers records. I blindly gave a list without much information about the list and promised I would cover it more detail.</p> <p>Here is the list of settings I chose:</p> <ul> <li>DC</li> <li>DcByGuid</li> <li>Gc</li> <li>GcIpAddress</li> <li>GenericGC</li> <li>Kdc</li> <li>Ldap</li> <li>LdapIpAddress</li> <li>Rfc1510UpdKdc</li> <li>Rfc1510Kpwd</li> <li>Rfc1510UpdKdc</li> <li>Rfc1510UdpKpwd</li> <li>Rfc1510UpdKdc</li> </ul> <p>If you look at the policy setting itself, it gives us a list of what these settings do, except it is terribly hard to read. I copied the list out and formatted it for easier reading. I have bolded the one\u2019s we are using.</p> GPO Setting Record Type Record FQDN LdapIpAddress A Ldap SRV _ldap._tcp. LdapAtSite SRV _ldap._tcp.._sites. Pdc SRV _ldap._tcp.pdc._msdcs. Gc SRV _ldap._tcp.gc._msdcs. GcAtSite SRV _ldap._tcp.._sites.gc._msdcs. DcByGuid SRV _ldap._tcp..domains._msdcs. GcIpAddress A gc._msdcs. DsaCname CNAME ._msdcs. Kdc SRV _kerberos._tcp.dc._msdcs. KdcAtSite SRV _kerberos._tcp.._sites.dc._msdcs. Dc SRV _ldap._tcp.dc._msdcs. DcAtSite SRV _ldap._tcp.._sites.dc._msdcs. Rfc1510Kdc SRV _kerberos._tcp. Rfc1510KdcAtSite SRV _kerberos._tcp.._sites. GenericGc SRV _gc._tcp. GenericGcAtSite SRV _gc._tcp.._sites. Rfc1510UdpKdc SRV _kerberos._udp. Rfc1510Kpwd SRV _kpasswd._tcp. Rfc1510UdpKpwd SRV _kpasswd._udp. <p>This chat makes it pretty easy to see what is going on. We are preventing DCs from registering any generic records and only allowing them to register records in their site. This way if a client cannot find a DC in its site, only the Root DCs will have registered records for the clients to reach out to.</p>","tags":["windows","windows-server","bitlocker"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/","title":"Configuring the AD Site Topology for Non-Routed Networks","text":"<p>Over the past year, I have been in a number of conversations about setting up Active Directory Sites and Services in a network that is not fully routed. Articles exist on the subject \u2014 some from Microsoft and some not. All the articles seem to skip a step or don\u2019t linger on a detail I\u2019d like to expand on.</p> <p>The question of \u201cHow do I configure Active Directory in a non-routed environment?\u201d isn\u2019t uncommon. With more organizations segmenting out their networks, with more B2B contracts encouraging companies to play well with one another, or whatever the need to ensure that AD plays across confusing site designs is imperative.</p> <p>Fortunately, there resources and articles out that detailing just this sort of thing. Unfortunately, like all things, they are often incomplete or gloss over an important step. Even more unfortunate, with Microsoft\u2019s recent drive to remove \u201coutdated\u201d documentation some of the gems of the past have gone missing. I hope to give some insight into how to configure AD to work with non-routed or poorly routed networks. I will focus on the Sites and Services side and give some guidance on the GPOs, firewall policies, and as many details that make sense as I dig into it.</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#lab-setup","title":"Lab Setup","text":"<p>have a CORP domain with two sites, CORP and WAREHOUSE (WH), and two child domains spun off of the CORP parent, RETAIL and OPS. RETAIL and OPS need to be segregated from each other and from WAREHOUSE. Everyone needs to be able to talk back and forth with the CORP site.</p> <p>Each site has its own subnet in my design. The subnets are routed in my lab since that is how my lab is setup. Rather than breaking the routes I\u2019m using Windows Firewall to block MS-RPC and LDAP traffic between the sites and warehouse.</p> <p>Another thing worth mentioning is I disabled Bridge All Site Links (BASL) and changed how DCs create SRV records. I\u2019ll explain why I did this below but understand that it is a crucial part to how this whole thing is architected.</p> <p>Last, the specific details about the lab (number of DCs, DC hardware, etc.) are left out. It shouldn\u2019t matter in this step. All that matters is that every site has a DC and every DC has a site.</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#disclaimer-1-proper-site-design","title":"Disclaimer #1 \u2013 Proper Site Design","text":"<p>I\u2019ve looked at a lot of environments and worked with a lot of admins trying to make their AD work like a charm. One of the most neglected, yet critical, pieces of a proper AD setup is the Site and Services configuration. This is even more prevalent in medium-sized organizations and larger as they tend to have more sites and thus more complexity. Admins tend to setup AD Sites and Services with the out-of-the-box defaults and it just works. Why change it? Or, they don\u2019t understand it enough to change it with confidence.</p> <p>For a non-routed AD topology to work, your Sites and Services must be solid. If it isn\u2019t there will be issues. Map your subnets to their sites, ensure that proper sites are configured, make sure that ever site has a DC, etc. These are all import. However, you must understand your network topology appropriately and make sure that that topology is correctly mirrored in AD Sites and Services (within reason).</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#testing-it-all-before-breaking-it-all","title":"Testing it All Before Breaking it All","text":"<p>Before breaking an environment it is important to know that said environment works. I want my directory full converged with all DCs having successful replications and a DNS that resolves as I would expect.</p> <p>I ran the following checks on every DC to verify everything worked. If these come back without errors it is likely all things are peachy.</p> <pre><code>dcdiag\nRepadmin /showrepl /errorsonly\nRepadmin /replsum\nNltest /dsgetdc:\nNltest /dsgetdc: /avoidself\nNltest /dsgetdc:company.pri\nNltest /dsgetdc:retail.company.pri\nNltest /dsgetdc:ops.company.pri\n</code></pre>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#sites-and-services-setup","title":"Sites and Services Setup","text":"<p>Each of the sites I mentioned above were created with their own /24 subnet. Site Links were created back to the CORP site. To make sure replication worked as I expected, I wanted to make sure that each site link has both a low cost and have a short replication interval. I also went through and configured change notification on each site link.</p> <p>The default cost is 100 and the default replication interval is 180 minutes. That is fine, but I like to change those\u00a0 numbers. Three hours for convergence with just one set of links is not fast enough for my setup. Remember that site link costs are cumulative. Assuming for a moment that I wanted WAREHOUSE to replicate something with RETAIL they have to cross between CORP to do that. This means that with a replication period of 180 minutes for each site link it could take a total of 360 minutes for the change in WAREHOUSE to get to RETAIL. Let\u2019s change the defaults. Change notification gets around some of this but we want the replication costs set right. Some stuff will always use that even with notify turned on.</p> <p></p> <p>Altering the cost and replication interval of the site links is very straight forward. I\u2019ll set the cost to 50 and the interval to the lowest possible value: 15. I\u2019ll be using PowerShell to do this, it is a one-and-done method that has a lot fewer clicks.</p> <pre><code>Get-ADReplicationSiteLink -Filter * | Set-ADReplicationSiteLink -Cost 50 -ReplicationFrequencyInMinutes 15\n</code></pre> <p>The above command first grabs all the Site Links in the forest (remember Sites and Services is a forest-wide part of AD). I then send those to Set-ADReplicationSiteLink and alter the cost and the replication frequency.</p> <p>Next, it is time to enable change notification on the site links. Within a site change notification is the default. Changing site links to behave the same way effectively makes the DCs all act as if they are in one site, even though great distances may be between them. This all means that the DCs in all my sites will converge very quickly, likely under a minute.</p> <p>Change Notification tells domain controllers to notify replication partners immediately upon receiving a change. If I add a user to a new group, in this scenario, the DC would notify its partners immediately that the change happened and then they would request the change be replicated. Without change notification the DCs store up changes and send all the data as a big chunk of replication traffic at every replication interval. Rather than communicating larger pieces of information periodically change notification communicates with a frequent, but small, series of notifications about changes.</p> <p>I changed change notification because Microsoft has been recommending it for most environments for years. Smaller environments may not even need it as they are unlikely to have multiple sites. Medium and larger environments could benefit from it assuming their sites are well-connected.</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#disclaimer-2-risks-of-change-notify","title":"DISCLAIMER #2 \u2013 Risks of Change Notify","text":"<p>First, DCs are more chatty. They send little pieces of information rather than large pieces. Bandwidth-wise this shouldn\u2019t matter all that much but I have seen cases where it wasn\u2019t an ideal setup.</p> <p>Second, if you have already configured options on your site link (you will know if you have) if you blindly follow my steps you can blow away what you currently have which may not be ideal. The options field uses bitmasks. If you have any concerns about blowing something away, check the References section below for some notes and do some of your own research beforehand.</p> <p>Finally, another risk of change notify is speed of changes. In a standard replication model, if I were to change the group membership of a user it would queue up that change and send it during the replication interval later. If I were to change that user\u2019s group membership a second time before the interval hit, both changes go through. If that second change were to remove the user from the group I had just added them to, only the second changes goes through as AD would only send what was relevant. Change notification will make it where each change along the course of work will be near immediately replicated. So your mistakes may become environment-wide mistakes faster with change notification on. This is a minor risk as most changes are rather non-impacting on their own, but keep all that in mind as you go forward.</p> <p></p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#configuring-change-notification","title":"Configuring Change Notification","text":"","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#manual-method","title":"Manual Method","text":"<ol> <li>Right-Click the Site Link \\ Properties</li> <li>Attribute Editor Tab</li> <li>Locate the Options Attribute</li> <li>Edit \u201cOptions\u201d</li> <li>Set the value to \u201c1\u201d</li> <li>Options should now show \u201c0x1 = (USE_NOTIFY)\u201d</li> </ol>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#powershell-method","title":"PowerShell Method","text":"<pre><code>Get-ADReplicationSiteLink -Filter * | Set-ADReplicationSiteLink -Add @{\"options\"=1}\n</code></pre> <p>In the Powershell method I set it for every site link at once. I also hope you noticed there isn\u2019t a -UseNotify or -Options switch on the command. Microsoft decided to make this command a little complicated. Fortunately, the -Add switch and its kindred allows us to do just about whatever we need to the attributes on this object type.</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#disclaimer-3-why-are-you-not-routing-your-sites","title":"Disclaimer #3 \u2013 Why Are You Not Routing Your Sites?","text":"<p>We are now ready to start creating a non-routed site and services topology. But first, I want to ask the question:\u00a0Why are you not routing your sites?</p> <p>A lot of organizations I\u2019ve worked with do this because of \u201csecurity\u201d reasons. Tenant A shouldn\u2019t be able to talk to Tenant B. If that is the case, while this design accomplishes that goal the best practice is to create separate forests. AD assumes all sites and domains in a forest can talk with one another, at least to some degree. If you break those sites or domains off into their own forests, there is no assumption of communication. I know there are some administrative hurdles there but those are not something that can\u2019t be dealt with.</p> <p>I\u2019m not saying that you are chosing a bad design, I\u2019m simply asking that you consider moving forward cautiously. Make sure you understand why you want to do this and that it makes the best sense for your environment. There is rule of thumb with AD, even a blog post about it from Microsoft: You are not smarter than the KCC. So let it do what it does.</p> <p>https://docs.microsoft.com/en-us/archive/blogs/markmoro/you-are-not-smarter-than-the-kcc</p> <p>Okay, that is my final warning before we start doing this.</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#creating-a-non-routed-site-design","title":"Creating a Non-Routed Site Design","text":"<p>As I said before, rather than configuring my Vyos lab router to not route between my /24 links, I decided to use the Windows Defender Firewall to block LDAP 389 and the RPC Dynamic Port Range (49152 \u2013 65535) for each domain. I only blocked it inbound on the other domains controllers. I have more details on this and some its challenges in the \u201cDig Deeper\u201d section at the end of this post.</p> <p>This method is not the recommended way to firewall off sites and I only did it out of convenience. If you wanted to do this in production, work with your network team and properly route/firewall your network.</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#disabling-bridge-all-site-links","title":"Disabling Bridge All Site Links","text":"<p>By default Active Directory bridges all site links together. This allows every site to have a \u201cdirect\u201d connection with every other site which means AD will create connections between sitelinks to create a intersite mesh topology of sorts. It also ensure that replication can go in virtually any direction. Remember the goal of the ISTG and KCC in this case to ensure the topology that achieves convergence as quickly as possible.</p> <p>In a normal environment, Bridge All Site Links (BASL) should be left on. It works and most environments don\u2019t do anything weird with their sites like this. That being said, Microsoft does have two scenarios where they recommend disabling BASL: 1) the network is not fully routed and 2) you need to control the flow of replication manually. Generally, you have the second scenario because of the first or you have an enormous environment that doesn\u2019t allow for natural replication paths.</p> <p>https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/creating-a-site-link-bridge-design</p> <p>Obviously, I\u2019m doing it because our sites aren\u2019t intended to communicate. Why create links that won\u2019t work anyway. So let\u2019s just turn it off. If for some reason you were relying on Bridge All Site Links for something, you can simply setup a manual site link bridge between those site links.</p> <p></p> <ol> <li>Login to one of the root domain controllers</li> <li>Launch AD Sites and Services</li> <li>Expand Sites</li> <li>Expand \u201cInter-Site Transports\u201d</li> <li>Right-Click \u201cIP\u201d \\ Choose \u201cProperties\u201d</li> <li>On the General Tab \\ Uncheck \u201cBridge all site links\u201d</li> </ol> <p></p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#disabled-via-powershell","title":"Disabled via Powershell","text":"<pre><code>$ConfigDN = (Get-ADRootDSE).configurationNamingContext\nSet-ADObject -Identity \"CN=IP,CN=Inter-Site Transports,CN=Sites,$ConfigDN\" -Replace @{\"options\"=2}\n</code></pre> <p>According to the Open Protocol Information put out by Microsoft, there are only two options that can be configured on the Inter-Site Transports containers (IP or SMTP): Ignore Schedules and Bridge All Site Links. I think the likelihood of running into a scenario where the -Replace option for Powershell overwriting an existing option is remote. If you are concerned, use Get-ADObject to confirm your current configuration and adjust accordingly. See the below link to see the different options for the IP Container.</p> <p>https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/66db6a63-52d2-4980-b87b-7b2d598dba81</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#changing-how-ad-srv-records-are-registered","title":"Changing How AD SRV Records are Registered","text":"<p>Normally, AD does some cool stuff with SRV record registration. Specifically, DCs will log and respond to generic SRV records created in the root domain of a forest to help locate global catalogs services such as LDAP and Kerberos, among other things. These generic records act as fallback records if a site loses its DCs for whatever reason. A client will simply find a random DC to talk to so communication stays up.</p> <p>Since we\u2019ve firewalled off our different sites, I\u00a0 don\u2019t want a bunch of site records in the root of the domain that just go anywhere. I want only the root DC records in the root and the specific sub-domain DC records in their specific domains. The root will be able to handle if something goes wrong with the site but not another domain.</p> <p>Let\u2019s look at the defaults and then decide what to do.</p> <ol> <li>Launch DNS Management (dnsmgmt.msc)</li> <li>Expand Forward Lookup Zones</li> <li>Expand your root domain name</li> <li>Click on _tcp</li> <li>Specifically we are looking at the _gc records</li> </ol> <p></p> <p>Notice how we have a GC record for every domain controller in the domain. AD logs a record for each GC, and other records, in a generic record to help with DC Locator. First a client will try to locate a DC in its site and if that fails it passes up to the root \u201cgeneric\u201d records and receives a random entry that can be any domain controller in the domain or forest.</p> <p>You can view the site entries with the following nslookup query to return GCs only in the OPS site.</p> <pre><code>nslookup -type=srv _gc._tcp.OPS._sites.company.pri\n</code></pre> <p></p> <p>So the scenario we are looking at is that if a client looks for a GC in its site, either of the OPS DCs can respond. That is what we want. However, if a DC in the OPS site cannot respond or doesn\u2019t respond fast enough, DC Locator may step up and try to do a generic query to _gc._tcp.Company.Pri. That query can return any DC in the forest. If had blocked 3268/3269 or any communication is lost between my host and these DCs, how are GC queries supposed to work? It could possibly sit there and loop through the list of GCs until it finds a server it can talk to or it times out (55 hops).</p> <p>Never fear! There is a solution to this problem. We need to create a Group Policy. Actually, we need several.</p> <p>==DO NOT LINK THIS POLICY IN THE ROOT SITE/DOMAIN!!!==</p> <ol> <li>Launch Group Policy Management Editor</li> <li>Create a new policy called \u201cDC DNS Registration\u201d or something similar.</li> <li>Edit the new policy.</li> <li>Browse to \u201cComputer Configuration \\ Policies \\ Administrative Templates \\ System \\ Net Logon \\ DC Locator\u201d</li> <li>Double Click the setting \u201cSpecify DC Locator DNS records not registered by the DCs\u201d</li> <li>Specify the following values (I will cover these in the Digging Deeper section later). <code>DC DcByGuid Gc GcIpAddress GenericGC Kdc Ldap LdapIpAddress Rfc1510UpdKdc Rfc1510Kpwd Rfc1510UpdKdc Rfc1510UdpKpwd</code></li> <li>Close out the group policy editor and save the policy</li> <li>In GPMC Right-Click \u201cDomains\u201d \\ Choose \u201cShow Domains\u201d</li> <li>Choose one of the other child domains (Note: this must be done in the root if you killed 389)</li> <li>Right-Click the \u201cDC DNS Registration\u201d policy \\ Choose \u201cCopy\u201d</li> <li>Navigate to one of the other child domains in GPMC \\ Expand \u201cGroup Policy Objects\u201d</li> <li>Right Click \u201cGroup Policy Objects\u201d \\ Choose \u201cPaste\u201d</li> <li>Next through the prompts to copy the policy</li> <li>Link the policy to the Domain Controllers OU in the child domains. NOTE: For the love of all that is holy, please test the policy before going nuts and linking it in prod. If you brick your prod, it isn\u2019t my fault!</li> <li>Login to one of the child DCs and run gpupdate /force. I also suggest rebooting</li> <li>Repeat this process for other child domains.</li> </ol> <p>You may not have to reboot \u2013 most administrative template GPOs are real-time and take effect immediately without reboot. However, with computer policies its hard to predict. We also need the Netlogon service to restart as that will remove the old DNS records (assuming Dynamic DNS Registration is turned on).</p> <p>When the server comes back up, login and check your records. You may need to bounce Netlogon a couple of times and do an ipconfig /registerdns to clear the old records. Ultimately, if the records don\u2019t go away you can delete them manually out of DNS and they should not re-register.</p> <p></p> <p>You can see that the list got smaller with those records removed. Now if a GC in the local site cannot be resolved, we head up to the root for help instead of finding a random server in some random site/domain. I ran through my checks and everything looked healthy so this worked. You may receive some errors with nltest looking cross domains as those domains cannot talk and you will receive errors in the <code>repadmin /replsum</code> since the environment isn\u2019t fully routed.</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#conclusion","title":"Conclusion","text":"<p>I hope this helped you out! Send me a message or leave a comment if you have questions or if there is something else you\u2019d like me to cover. As always, test in non-prod or test environments before implementing any of this in production. See the below sections for references I used and some deeper dives into a couple of areas.</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#references","title":"References","text":"<p>Site Link Bridge Design https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/creating-a-site-link-bridge-design</p> <p>Enable or Disable Site Link Bridges https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc738789(v=ws.10)</p> <p>Preventing Spoke DCs from Advertising in the Hub for Authentication and Availability https://support.microsoft.com/en-us/help/816587/how-to-verify-that-srv-dns-records-have-been-created-for-a-domain-cont</p> <p>How to verify that SRV DNS Records have been created for a DC https://support.microsoft.com/en-us/help/816587/how-to-verify-that-srv-dns-records-have-been-created-for-a-domain-cont</p> <p>Optimize Location of a DC or GC https://support.microsoft.com/en-us/help/306602/how-to-optimize-the-location-of-a-domain-controller-or-global-catalog</p> <p>IP Container Bitmasks https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/66db6a63-52d2-4980-b87b-7b2d598dba81</p> <p>AD Firewall Stuff https://support.microsoft.com/en-us/help/179442/how-to-configure-a-firewall-for-domains-and-trusts</p> <p>Change Notification and You https://blogs.msdn.microsoft.com/canberrapfe/2012/03/25/active-directory-replication-change-notification-you/</p> <p>You are not smarter than the KCC</p> <p>https://blogs.technet.microsoft.com/markmoro/2011/08/05/you-are-not-smarter-than-the-kcc/</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#digging-deeper","title":"Digging Deeper","text":"","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#windows-firewall-configuration-to-lock-down-child-domains","title":"Windows Firewall Configuration to Lock Down Child Domains","text":"<p>As I mentioned above, I used Windows Firewall to lock down my sites and domains to prevent communication. Here are the settings I used and some reasoning behind my choices. I would not advise blocking 389 as it really screws with some management functions and can slow down AD (though in production you should be using 636 anyway). To block replication you should focus on the RPC Dynamic Range. You would probably want to do more blocks and more restrictions if you wanted to actually block two child domains.</p> <p>Ultimately, I would recommend doing these configurations with hardware firewalls and the like. This isn\u2019t really a sound use-case for Windows Firewall.</p> <p>==NOTE: DO NOT LINK THIS POLICY IN THE ROOT DOMAIN!!==</p> <ol> <li>Launch Group Policy Management Center</li> <li>Expand Domains \\ Select the domain that you wish to create the policy in</li> <li>Right-Click \u201cGroup Policy Objects\u201d \\ New</li> <li>Name the policy</li> <li>Right-Click the new policy \\ Edit</li> <li>Navigate to \u201cComputer Configuration \\ Policies \\ Windows Settings \\ Security Settings\u201d</li> <li>Expand \u201cWindows Firewall with Advanced Security\u201d</li> <li>Expand \u201cWindows Firewall with Advanced Security\u201d (Firewall Icon)</li> <li>Click \u201cInbound Rule\u201d</li> <li>Right-Click \u201cNew Rule\u201d</li> <li>Choose Port</li> <li>Leave TCP Selected</li> <li>Configure the following ports: 389, 49152-65535</li> <li>Choose to \u201cBlock the connection\u201d</li> <li>Leave all profiles selected</li> <li>Name the firewall rule (e.g. Block TCP 389, 49152-65535)</li> <li>Find the rule you just created \\ Right-Click the rule \\ Properties</li> <li>Click the \u201cScope\u201d tab</li> <li>Select \u201cThese IPs under Remote IP Address\u201d</li> <li>Add the different IPs of of the DCs you DO NOT want to talk to the DC this rule applies to.</li> <li>Click OK</li> <li>Repeate 10 \u2013 21 except configuring UDP instead of TCP.</li> <li>Repeat this process again for each domain you wish to lock down making sure to configure the correct IPs in the scope section.     DO NOT DO THIS IN THE ROOT DOMAIN</li> <li>Link the policies where appropriate.</li> </ol> <p>If you have separate sites in your root domain that you would like to lock down you\u2019ll need to use Security Filtering with Group Policy to target the DCs that you wish to restrict. I would avoid using site policies, even though this seems like a use case, as they don\u2019t always behave as you would expect and most admins don\u2019t know to check for or pay attention to them.</p> <p>If you wish to get more specific about what is being blocked, you can narrow down which ports are used for AD to a very granular level. See the \u201cMore Information\u201d section and the \u201cWindows Server 2008 and later versions\u201d section for the latest and greatest port list in the below link.</p> <p>https://support.microsoft.com/en-us/help/179442/how-to-configure-a-firewall-for-domains-and-trusts</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#site-links-vs-site-link-bridges","title":"Site Links vs Site Link Bridges","text":"<p>I\u2019m not going to lie to you. I honestly see no real use case for a Site Link Bridge. In my opinion Site Links cover the same topic and work fine. However, Microsoft has them so let\u2019s take a minute to talk about them.</p> <p>First, some definitions.</p> <p>Site Links are objects that represent logical paths that the KCC uses to establish connections for Active Directory replication. Sites contained within a site link use the same network cost to communicate through the specified inter-site transport (IP. SMTP is a relic of the past). Any sites in a site link are said to be connected by the means of the same network type. They are not intended to mirror actual network paths so redundant links is superfluous. When a site link is created between two sites, the KCC/ISTG automatically creates connections between DCs in each site via Bridgehead servers.</p> <p>Site Link Bridges are similar, they represent a set of site links that can communicate using the same transport. Bridges are used represent more indirect connections. The replication traffic will likely have to traverse more complicated routes to get from one site to another. The default is for the KCC to assume transitivity between all site links and thus create bridges in its own topology. The KCC will use any combination of included site links to establish the least expensive route to interconnect the domain controllers. The KCC adds up the cost of each additional site link and uses that sum for the bridged path\u2019s cost.</p> <p>Basically it breaks down to this: Site Links are for direct connections that would be physically adjacent networks and Site Link Bridges are used to connect networks that are not directly connected and must communicate via an intermediary.</p> <p>https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/replication/active-directory-replication-concepts#BKMK_6</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"2021/04/22/configuring-the-ad-site-topology-for-non-routed-networks/#gpo-settings-overview","title":"GPO Settings Overview","text":"<p>Above we configured the Net Logon group policy to skip over specific records when Netlogon dynamically registers records. I blindly gave a list without much information about the list and promised I would cover it more detail.</p> <p>Here is the list of settings I chose:</p> <ul> <li>DC</li> <li>DcByGuid</li> <li>Gc</li> <li>GcIpAddress</li> <li>GenericGC</li> <li>Kdc</li> <li>Ldap</li> <li>LdapIpAddress</li> <li>Rfc1510UpdKdc</li> <li>Rfc1510Kpwd</li> <li>Rfc1510UpdKdc</li> <li>Rfc1510UdpKpwd</li> <li>Rfc1510UpdKdc</li> </ul> <p>If you look at the policy setting itself, it gives us a list of what these settings do, except it is terribly hard to read. I copied the list out and formatted it for easier reading. I have bolded the one\u2019s we are using.</p> GPO Setting Record Type Record FQDN LdapIpAddress A Ldap SRV _ldap._tcp. LdapAtSite SRV _ldap._tcp.._sites. Pdc SRV _ldap._tcp.pdc._msdcs. Gc SRV _ldap._tcp.gc._msdcs. GcAtSite SRV _ldap._tcp.._sites.gc._msdcs. DcByGuid SRV _ldap._tcp..domains._msdcs. GcIpAddress A gc._msdcs. DsaCname CNAME ._msdcs. Kdc SRV _kerberos._tcp.dc._msdcs. KdcAtSite SRV _kerberos._tcp.._sites.dc._msdcs. Dc SRV _ldap._tcp.dc._msdcs. DcAtSite SRV _ldap._tcp.._sites.dc._msdcs. Rfc1510Kdc SRV _kerberos._tcp. Rfc1510KdcAtSite SRV _kerberos._tcp.._sites. GenericGc SRV _gc._tcp. GenericGcAtSite SRV _gc._tcp.._sites. Rfc1510UdpKdc SRV _kerberos._udp. Rfc1510Kpwd SRV _kpasswd._tcp. Rfc1510UdpKpwd SRV _kpasswd._udp. <p>This chat makes it pretty easy to see what is going on. We are preventing DCs from registering any generic records and only allowing them to register records in their site. This way if a client cannot find a DC in its site, only the Root DCs will have registered records for the clients to reach out to.</p>","tags":["active-directory","windows-server","replication","group-policy"]},{"location":"archive/2021/","title":"2021","text":""},{"location":"archive/2020/","title":"2020","text":""}]}